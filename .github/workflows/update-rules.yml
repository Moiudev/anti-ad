name: Update Rules

on:
  schedule:   # è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯ 2 å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: "0 */2 * * *"

  workflow_dispatch:   # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œå¯åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨è¿è¡Œå·¥ä½œæµ

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      PYTHONUNBUFFERED: 1  # å®æ—¶è¾“å‡º Python æ—¥å¿—

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub ä»¤ç‰Œè¿›è¡Œè®¤è¯

    # è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    # ç¼“å­˜ä¾èµ–
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ${{ github.workspace }}/hash_cache.json
        key: ${{ runner.os }}-py-${{ hashFiles('scripts/requirements.txt') }}

    # å®‰è£… Python ä¾èµ–
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r scripts/requirements.txt

    # è¿è¡Œå¤„ç†è„šæœ¬ï¼Œç”¨äºç”Ÿæˆ anti-ad.json
    - name: Run processing script
      run: python scripts/process.py

    # ä¸‹è½½ sing-box å·¥å…·
    - name: Download sing-box
      run: |
        # é€šè¿‡ GitHub API è·å– sing-box æœ€æ–°ç‰ˆæœ¬å·
        LATEST_VERSION=$(curl -sL "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | jq -r '.tag_name' | sed 's/v//')

        # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ sing-box
        wget "https://github.com/SagerNet/sing-box/releases/download/v${LATEST_VERSION}/sing-box-${LATEST_VERSION}-linux-amd64.tar.gz"

        # è§£å‹ä¸‹è½½çš„æ–‡ä»¶
        tar -xzf sing-box-${LATEST_VERSION}-linux-amd64.tar.gz

        # ç§»åŠ¨ sing-box å¯æ‰§è¡Œæ–‡ä»¶åˆ°å½“å‰ç›®å½•
        mv sing-box-${LATEST_VERSION}-linux-amd64/sing-box .

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
        rm -r sing-box-${LATEST_VERSION}-linux-amd64*

    # ç¼–è¯‘è§„åˆ™é›†
    - name: Compile rule set
      run: |
        # æ·»åŠ æ‰§è¡Œæƒé™
        chmod +x sing-box

        # ç¼–è¯‘ JSON è§„åˆ™é›†ä¸º SRS æ ¼å¼
        ./sing-box rule-set compile --output ad.srs ad.json

    #  æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
    - name: Check for changes
      id: check-changes
      run: |
        # ä½¿ç”¨ git add -N å°†æœªè·Ÿè¸ªæ–‡ä»¶æ ‡è®°ä¸º"å¾…æ·»åŠ "çŠ¶æ€
        git add -N .

        # æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦æœ‰å˜æ›´
        if ! git diff --quiet; then
          # æ£€æµ‹åˆ°å˜æ›´ï¼šè®¾ç½®è¾“å‡ºå˜é‡ changes_detected=true
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "âœ… æ£€æµ‹åˆ°å˜æ›´ï¼Œå°†æäº¤æ›´æ–°"
        else
          # æ²¡æœ‰å˜æ›´ï¼šè®¾ç½®è¾“å‡ºå˜é‡changes_detected=false
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ æœªæ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi

    # æäº¤å¹¶æ¨é€å˜æ›´ï¼Œä»…åœ¨æ£€æµ‹åˆ°å˜æ›´æ—¶æ‰§è¡Œ
    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨ GitHub Actions é»˜è®¤èº«ä»½
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # æ·»åŠ å˜æ›´æ–‡ä»¶ï¼š
        #   ad.srs - ç¼–è¯‘åçš„è§„åˆ™é›†
        #   ad.json - åŸå§‹è§„åˆ™é›†
        #   rules/* - ä¸‹è½½çš„è§„åˆ™æºæ–‡ä»¶
        git add ad.srs ad.json rules/* hash_cache.json

        # è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼Œç”¨äºæäº¤ä¿¡æ¯
        TIMESTAMP=$(TZ="Asia/Shanghai" date +"%Y-%m-%d %H:%M")

        # æäº¤å˜æ›´
        git commit -m "è§„åˆ™æ›´æ–°äº $TIMESTAMP"

        # æ¨é€å˜æ›´åˆ°å½“å‰åˆ†æ”¯
        git push

        echo "ğŸš€ å˜æ›´å·²æäº¤å¹¶æ¨é€ï¼"
